name: CD - Deploy Frontend to AWS Amplify

# Requirements:
# - Automated deployment to AWS Amplify upon merge to main
# - Frontend accessible via Amplify hosting
# 
# Prerequisites (manual setup required):
# - AWS Amplify app connected to this GitHub repository
# - GitHub OIDC role with Amplify permissions (amplify:StartJob, amplify:GetApp, amplify:GetBranch)
# - GitHub secret: AWS_IAM_ROLE_ARN (reused from backend)
# - GitHub secret: AMPLIFY_APP_ID (required - your Amplify App ID from AWS Console)

on:
  push:
    branches: [ '100-frontend-shift-from-s3-to-amplify' ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deploy'
        required: false
        default: 'manual'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2
  AMPLIFY_BRANCH: main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and validate frontend
        run: |
          cd frontend
          npm ci
          npm run build
          # Run linting if available
          npm run lint || echo "Linting step skipped or failed (non-blocking)"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          role-session-name: gha-amplify-deploy

      - name: Get Amplify App ID
        id: get-amplify-app
        run: |
          # Require AMPLIFY_APP_ID secret (auto-detection requires amplify:ListApps permission)
          if [ -z "${{ secrets.AMPLIFY_APP_ID }}" ]; then
            echo "❌ AMPLIFY_APP_ID secret is required"
            echo ""
            echo "To fix this:"
            echo "1. Go to your GitHub repository settings > Secrets and variables > Actions"
            echo "2. Add a new secret named: AMPLIFY_APP_ID"
            echo "3. Set the value to your Amplify App ID (found in AWS Amplify Console)"
            echo ""
            echo "To find your Amplify App ID:"
            echo "- Go to AWS Amplify Console: https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }}"
            echo "- Select your app"
            echo "- The App ID is shown in the app details or URL"
            exit 1
          fi
          
          echo "APP_ID=${{ secrets.AMPLIFY_APP_ID }}" >> $GITHUB_OUTPUT
          echo "✅ Using Amplify App ID from secret"

      - name: Trigger Amplify deployment
        run: |
          APP_ID="${{ steps.get-amplify-app.outputs.APP_ID }}"
          BRANCH="${{ env.AMPLIFY_BRANCH }}"
          
          echo "Triggering Amplify deployment for app: $APP_ID, branch: $BRANCH"
          
          # Start a new build job
          JOB_ID=$(aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH" \
            --job-type RELEASE \
            --region ${{ env.AWS_REGION }} \
            --query 'jobSummary.jobId' \
            --output text)
          
          if [ -z "$JOB_ID" ] || [ "$JOB_ID" == "None" ]; then
            echo "❌ Failed to start Amplify deployment job"
            exit 1
          fi
          
          echo "✅ Amplify deployment job started: $JOB_ID"
          echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV
          
          # Wait a moment and check job status
          sleep 5
          JOB_STATUS=$(aws amplify get-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH" \
            --job-id "$JOB_ID" \
            --region ${{ env.AWS_REGION }} \
            --query 'job.summary.status' \
            --output text)
          
          echo "Deployment job status: $JOB_STATUS"
          echo "Monitor deployment in AWS Amplify Console: https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }}#/$APP_ID"

      - name: Output deployment info
        run: |
          APP_ID="${{ steps.get-amplify-app.outputs.APP_ID }}"
          echo "✅ Frontend Deployment Triggered"
          echo "Amplify App ID: $APP_ID"
          echo "Branch: ${{ env.AMPLIFY_BRANCH }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Job ID: ${{ env.JOB_ID }}"
          echo ""
          echo "View deployment status: https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }}#/$APP_ID"
