name: CD - Deploy Frontend to AWS Amplify

# Requirements:
# - Automated deployment to AWS Amplify upon merge to main
# - Frontend accessible via Amplify hosting
# 
# Prerequisites (manual setup required):
# - AWS Amplify app connected to this GitHub repository
# - GitHub OIDC role with Amplify permissions (amplify:StartJob, amplify:GetApp, amplify:GetBranch, amplify:ListApps)
# - GitHub secret: AWS_IAM_ROLE_ARN (reused from backend)
# - GitHub secret: AMPLIFY_APP_ID (optional - only needed if amplify:ListApps permission is not available)

on:
  push:
    branches: [ '100-frontend-shift-from-s3-to-amplify' ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deploy'
        required: false
        default: 'manual'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2
  AMPLIFY_BRANCH: main

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build and validate frontend
        run: |
          cd frontend
          npm ci
          npm run build
          # Run linting if available
          npm run lint || echo "Linting step skipped or failed (non-blocking)"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          role-session-name: gha-amplify-deploy

      - name: Get Amplify App ID
        id: get-amplify-app
        run: |
          # Try to use provided App ID first, otherwise auto-detect
          if [ -n "${{ secrets.AMPLIFY_APP_ID }}" ]; then
            echo "APP_ID=${{ secrets.AMPLIFY_APP_ID }}" >> $GITHUB_OUTPUT
            echo "✅ Using Amplify App ID from secret"
          else
            echo "Attempting to auto-detect Amplify App ID..."
            # Try to auto-detect by repository URL
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            APP_ID=$(aws amplify list-apps \
              --region ${{ env.AWS_REGION }} \
              --query "apps[?repository=='https://github.com/${{ github.repository }}'].appId" \
              --output text 2>/dev/null | head -n1 || echo "")
            
            if [ -z "$APP_ID" ] || [ "$APP_ID" == "None" ]; then
              # Try alternative detection by app name
              APP_ID=$(aws amplify list-apps \
                --region ${{ env.AWS_REGION }} \
                --query "apps[?name=='$REPO_NAME' || name=='ece461-frontend'].appId" \
                --output text 2>/dev/null | head -n1 || echo "")
            fi
            
            if [ -z "$APP_ID" ] || [ "$APP_ID" == "None" ]; then
              echo "❌ Could not auto-detect Amplify App ID"
              echo ""
              echo "You have two options to fix this:"
              echo ""
              echo "OPTION 1 (Recommended): Add IAM permission"
              echo "1. Go to IAM Console > Roles > github-actions-deploy-role"
              echo "2. Add permission: amplify:ListApps"
              echo "3. This will allow auto-detection to work"
              echo ""
              echo "OPTION 2: Add GitHub Secret"
              echo "1. Go to GitHub repository settings > Secrets and variables > Actions"
              echo "2. Add secret: AMPLIFY_APP_ID"
              echo "3. Set value to your Amplify App ID from AWS Console"
              echo ""
              echo "To find your Amplify App ID:"
              echo "- Go to: https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }}"
              echo "- Select your app"
              echo "- App ID is in the URL or app details"
              exit 1
            fi
            
            echo "APP_ID=$APP_ID" >> $GITHUB_OUTPUT
            echo "✅ Auto-detected Amplify App ID: $APP_ID"
          fi

      - name: Trigger Amplify deployment
        run: |
          APP_ID="${{ steps.get-amplify-app.outputs.APP_ID }}"
          BRANCH="${{ env.AMPLIFY_BRANCH }}"
          
          echo "Triggering Amplify deployment for app: $APP_ID, branch: $BRANCH"
          
          # Start a new build job
          JOB_ID=$(aws amplify start-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH" \
            --job-type RELEASE \
            --region ${{ env.AWS_REGION }} \
            --query 'jobSummary.jobId' \
            --output text)
          
          if [ -z "$JOB_ID" ] || [ "$JOB_ID" == "None" ]; then
            echo "❌ Failed to start Amplify deployment job"
            exit 1
          fi
          
          echo "✅ Amplify deployment job started: $JOB_ID"
          echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV
          
          # Wait a moment and check job status
          sleep 5
          JOB_STATUS=$(aws amplify get-job \
            --app-id "$APP_ID" \
            --branch-name "$BRANCH" \
            --job-id "$JOB_ID" \
            --region ${{ env.AWS_REGION }} \
            --query 'job.summary.status' \
            --output text)
          
          echo "Deployment job status: $JOB_STATUS"
          echo "Monitor deployment in AWS Amplify Console: https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }}#/$APP_ID"

      - name: Output deployment info
        run: |
          APP_ID="${{ steps.get-amplify-app.outputs.APP_ID }}"
          echo "✅ Frontend Deployment Triggered"
          echo "Amplify App ID: $APP_ID"
          echo "Branch: ${{ env.AMPLIFY_BRANCH }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Job ID: ${{ env.JOB_ID }}"
          echo ""
          echo "View deployment status: https://console.aws.amazon.com/amplify/home?region=${{ env.AWS_REGION }}#/$APP_ID"
