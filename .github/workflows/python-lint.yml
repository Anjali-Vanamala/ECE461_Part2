name: Python Lint, Import Sort, Typing

on:
  pull_request:
    branches:
      - '**'

jobs:
  lint-import-typing:
    runs-on: ubuntu-latest

    env:
      LOG_FILE: /tmp/test_log.txt
      LOG_LEVEL: "1"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------
      #   PRINT DIRECTORY STRUCTURE
      # --------------------------
      - name: Show directory tree + pwd
        run: |
          echo "Current working directory:"
          pwd
          echo ""
          echo "Listing workspace:"
          ls -R .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dependencies.txt
          pip install flake8 isort mypy coverage uvicorn pytest
          pip install types-requests types-python-dateutil

      # --------------------------
      #  LINTING + TYPE CHECKING
      # --------------------------
      - name: Run flake8 (Python linter)
        run: flake8 . --count --show-source --statistics --ignore=E501

      - name: Run isort (import sorter)
        run: isort . --check --diff

      - name: Run mypy (type checker)
        run: mypy . --ignore-missing-imports

      - name: Add project root to PYTHONPATH
        run: |
          echo "PYTHONPATH=$PWD" >> $GITHUB_ENV
          echo "Added $PWD to PYTHONPATH"

      # -----------------------------------------------------
      # CREATE .coveragerc for auto-coverage in subprocesses
      # -----------------------------------------------------
      - name: Create coverage config
        run: |
          cat > .coveragerc << 'EOF'
          [run]
          parallel = True
          source = backend
          concurrency = thread, greenlet

          [report]
          show_missing = True
          EOF

      # Export auto-coverage BEFORE uvicorn starts
      - name: Export COVERAGE_PROCESS_START
        run: |
          echo "COVERAGE_PROCESS_START=$PWD/.coveragerc" >> $GITHUB_ENV

      # --------------------------
      #   RUN BACKEND (auto coverage)
      # --------------------------
      - name: Start backend (auto coverage)
        shell: bash
        env:
          BASE: "http://localhost:8000"
        run: |
          export COVERAGE_PROCESS_START="$COVERAGE_PROCESS_START"
          echo "Auto coverage enabled with: $COVERAGE_PROCESS_START"

          echo "Starting backend with uvicorn..."
          nohup python -m uvicorn backend.app:app \
              --host 0.0.0.0 --port 8000 > server.log 2>&1 &

          echo "Waiting for server..."
          sleep 3
          echo "---- Server startup log ----"
          cat server.log || true

          for i in {1..30}; do
            if curl -fsS "$BASE/health" >/dev/null 2>&1; then
              echo "Server is up."
              break
            fi
            echo "Server not ready yet ($i/30)..."
            sleep 1
          done

          if ! curl -fsS "$BASE/health" >/dev/null 2>&1; then
            echo "ðŸš¨ Server failed to start."
            cat server.log || true
            exit 1
          fi

      # --------------------------
      # PYTEST (auto coverage)
      # --------------------------
      - name: Run pytest
        run: pytest tests_main.py --maxfail=0

      # --------------------------
      # POWERSHELL INTEGRATION TESTS
      # --------------------------
      - name: Pre-checks for integration tests (PowerShell)
        shell: pwsh
        env:
          BASE: "http://localhost:8000"
        run: |
          Write-Host "Running integration tests against $env:BASE"
          Invoke-RestMethod -Uri "$env:BASE/health" -Method Get
          Invoke-RestMethod -Uri "$env:BASE/reset" -Method Delete

      - name: Run PowerShell integration tests (auto coverage)
        shell: bash
        env:
          BASE: "http://localhost:8000"
        run: |
          export COVERAGE_PROCESS_START="$COVERAGE_PROCESS_START"

          echo "Running integration tests with auto coverage..."

          cat > run_ps_integration.py << 'EOF'
          import subprocess
          subprocess.check_call(["pwsh", "./integration_tests.ps1"])
          EOF

          python run_ps_integration.py

      # --------------------------
      # COMBINE & ENFORCE COVERAGE (Fail < 60%)
      # --------------------------
      - name: Combine + Report Coverage (Fail <60)
        run: |
          echo "Combining coverage..."
          coverage combine
          coverage report -m --fail-under=60
