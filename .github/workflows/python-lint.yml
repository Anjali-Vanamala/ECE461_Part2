name: Python Lint, Import Sort, Typing

on:
  pull_request:
    branches:
      - '**'

jobs:
  lint-import-typing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dependencies.txt
          pip install flake8 isort mypy coverage uvicorn pytest
          pip install types-requests types-python-dateutil

      # --------------------------
      #  LINTING + TYPE CHECKING
      # --------------------------
      - name: Run flake8 (Python linter)
        run: flake8 . --count --show-source --statistics --ignore=E501

      - name: Run isort (import sorter)
        run: isort . --check --diff

      - name: Run mypy (type checker)
        run: mypy . --ignore-missing-imports

      # --------------------------
      #   RUN BACKEND UNDER COVERAGE
      # --------------------------
      name: Python Lint, Import Sort, Typing

on:
  pull_request:
    branches:
      - '**'

jobs:
  lint-import-typing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dependencies.txt
          pip install flake8 isort mypy coverage uvicorn pytest
          pip install types-requests types-python-dateutil

      # --------------------------
      #  LINTING + TYPE CHECKING
      # --------------------------
      - name: Run flake8 (Python linter)
        run: flake8 . --count --show-source --statistics --ignore=E501

      - name: Run isort (import sorter)
        run: isort . --check --diff

      - name: Run mypy (type checker)
        run: mypy . --ignore-missing-imports

      # --------------------------
      #   RUN BACKEND UNDER COVERAGE
      # --------------------------
      - name: Start backend under coverage
        shell: bash
        env:
          BASE: "http://localhost:8000"
        run: |
          nohup coverage run --parallel-mode --source=. \
              -m uvicorn backend.app:app --host 0.0.0.0 --port 8000 &

          echo "Waiting for server to become healthy at $BASE/health ..."

          # Poll /health with a timeout (30s). Use curl -fsS to fail silently on non-2xx and suppress progress.
          for i in {1..30}; do
            if curl -fsS "$BASE/health" >/dev/null 2>&1; then
              echo "Server is up after $i second(s)."
              break
            fi
            echo "Server not ready yet ($i/30)..."
            sleep 1
          done

          # Final check: exit non-zero if server never became healthy
          if ! curl -fsS "$BASE/health" >/dev/null 2>&1; then
            echo "Server did not start in time (30s timeout)." >&2
            # Print process list for debugging
            ps aux | sed -n '1,200p'
            # Show server logs (if any) for debugging - adjust path as needed
            # tail -n 200 nohup.out || true
            exit 1
          fi

      # --------------------------
      # PYTEST UNDER COVERAGE
      # --------------------------
      - name: Run pytest under coverage
        run: |
          coverage run --parallel-mode --source=. -m pytest tests_main.py --maxfail=0

      # --------------------------
      # POWERSHELL INTEGRATION TESTS
      # --------------------------
      # Do pre-checks in PowerShell (this must be pwsh so Invoke-RestMethod works)
      - name: Pre-checks for integration tests (PowerShell)
        shell: pwsh
        env:
          BASE: "http://localhost:8000"
        run: |
          Write-Host "Running integration tests against $env:BASE"

          # Pre-checks
          Invoke-RestMethod -Uri "$env:BASE/health" -Method Get
          Invoke-RestMethod -Uri "$env:BASE/reset" -Method Delete

      # Run the PowerShell integration script under coverage.
      # Use bash here-doc to feed Python stdin (bash supports <<'EOF').
      - name: Start backend under coverage
        shell: bash
        env:
          BASE: "http://localhost:8000"
        run: |
          echo "Starting backend with coverage..."
          nohup python -m coverage run --parallel-mode --source=. \
              -m uvicorn backend.app:app \
              --host 0.0.0.0 --port 8000 > server.log 2>&1 &

          echo "Waiting for server..."
          
          # Wait a moment for logs to populate
          sleep 3
          echo "---- Server startup log ----"
          cat server.log || true

          # Health-check loop
          for i in {1..30}; do
            if curl -fsS "$BASE/health" >/dev/null 2>&1; then
              echo "Server is up."
              break
            fi
            echo "Server not ready yet ($i/30)..."
            sleep 1
          done

          if ! curl -fsS "$BASE/health" >/dev/null 2>&1; then
            echo "ðŸš¨ Server failed to start."
            echo "---- Final server log ----"
            cat server.log || true
            exit 1
          fi

      # --------------------------
      # COMBINE & ENFORCE COVERAGE (Fail if < 60%)
      # --------------------------
      - name: Combine + Report Coverage (Fail <60)
        run: |
          coverage combine
          coverage report -m --fail-under=60


      # --------------------------
      # PYTEST UNDER COVERAGE
      # --------------------------
      - name: Run pytest under coverage
        run: |
          coverage run --parallel-mode --source=. -m pytest tests_main.py --maxfail=0

      # --------------------------
      # POWERSHELL INTEGRATION TESTS
      # --------------------------
      # Do pre-checks in PowerShell (this must be pwsh so Invoke-RestMethod works)
      - name: Pre-checks for integration tests (PowerShell)
        shell: pwsh
        env:
          BASE: "http://localhost:8000"
        run: |
          Write-Host "Running integration tests against $env:BASE"

          # Pre-checks
          Invoke-RestMethod -Uri "$env:BASE/health" -Method Get
          Invoke-RestMethod -Uri "$env:BASE/reset" -Method Delete

      # Run the PowerShell integration script under coverage.
      # Use bash here-doc to feed Python stdin (bash supports <<'EOF').
      - name: Run PowerShell integration tests (covered)
        shell: bash
        env:
          BASE: "http://localhost:8000"
        run: |
          echo "Running integration tests under coverage against $BASE"

          # Run script *under coverage* by launching a short Python process that calls pwsh.
          coverage run --parallel-mode --source=. -m python - <<'PY'
          import subprocess
          subprocess.check_call(["pwsh", "./integration_tests.ps1"])
          PY

      # --------------------------
      # COMBINE & ENFORCE COVERAGE (Fail if < 60%)
      # --------------------------
      - name: Combine + Report Coverage (Fail <60)
        run: |
          coverage combine
          coverage report -m --fail-under=60
