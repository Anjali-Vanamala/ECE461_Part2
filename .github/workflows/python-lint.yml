name: Python Lint, Import Sort, Typing

on:
  pull_request:
    branches:
      - '**'

jobs:
  lint-import-typing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dependencies.txt
          pip install flake8 isort mypy coverage uvicorn pytest
          pip install types-requests types-python-dateutil

      # --------------------------
      #  LINTING + TYPE CHECKING
      # --------------------------
      - name: Run flake8 (Python linter)
        run: flake8 . --count --show-source --statistics --ignore=E501

      - name: Run isort (import sorter)
        run: isort . --check --diff

      - name: Run mypy (type checker)
        run: mypy . --ignore-missing-imports

      # --------------------------
      #   RUN BACKEND UNDER COVERAGE
      # --------------------------
      - name: Start backend under coverage
        shell: bash
        run: |
          nohup coverage run --parallel-mode --source=. \
              -m uvicorn main:app --host 0.0.0.0 --port 8000 &
          echo "Waiting for server..."
          sleep 7

      # --------------------------
      # PYTEST UNDER COVERAGE
      # --------------------------
      - name: Run pytest under coverage
        run: |
          coverage run --parallel-mode --source=. -m pytest tests_main.py --maxfail=0

      # --------------------------
      # POWERSHELL INTEGRATION TESTS
      # --------------------------
      - name: Install PowerShell Core
        uses: PowerShell/PowerShell@v2

      - name: Run PowerShell integration tests (covered)
        shell: pwsh
        env:
          BASE: "http://localhost:8000"
        run: |
          Write-Host "Running integration tests against $env:BASE"

          # Pre-checks
          Invoke-RestMethod -Uri "$env:BASE/health" -Method Get
          Invoke-RestMethod -Uri "$env:BASE/reset" -Method Delete

          # Run script *under coverage* using python exec
          # (This forces Python to stay in coverage context)
          coverage run --parallel-mode --source=. `
              -m python - <<'EOF'
              import subprocess
              subprocess.check_call(["pwsh", "./integration_tests.ps1"])
              EOF

      # --------------------------
      # COMBINE & ENFORCE COVERAGE
      # --------------------------
      - name: Combine + Report Coverage (Fail <60)
        run: |
          coverage combine
          coverage report -m --fail-under=60
