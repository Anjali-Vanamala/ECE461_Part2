name: Python Lint, Import Sort, Typing

on:
  pull_request:
    branches:
      - '**'

jobs:
  lint-import-typing:
    runs-on: ubuntu-latest

    # GLOBAL ENV â€” inherited by ALL subprocesses
    env:
      LOG_FILE: /tmp/test_log.txt
      LOG_LEVEL: "1"
      COVERAGE_PROCESS_START: ${{ github.workspace }}/.coveragerc
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show directory tree + pwd
        run: |
          echo "PWD: $(pwd)"
          ls -R .

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r dependencies.txt
          pip install flake8 isort mypy coverage uvicorn pytest
          pip install types-requests types-python-dateutil

      # --------------------------
      #  LINTING + TYPE CHECKING
      # --------------------------
      - name: Run flake8 (Python linter)
        run: flake8 . --count --show-source --statistics --ignore=E501

      - name: Run isort (import sorter)
        run: isort . --check --diff

      - name: Run mypy (type checker)
        run: mypy . --ignore-missing-imports

      # -----------------------------------------------------
      # CREATE .coveragerc for auto-coverage
      # -----------------------------------------------------
      - name: Create coverage config
        run: |
          cat > .coveragerc << 'EOF'
          [run]
          parallel = True
          source = backend
          concurrency = thread, greenlet

          [report]
          show_missing = True
          EOF

      # --------------------------
      #   RUN BACKEND (auto coverage)
      # --------------------------
      - name: Start backend (auto coverage)
        shell: bash
        env:
          BASE: "http://localhost:8000"
        run: |
          echo "COVERAGE_PROCESS_START=$COVERAGE_PROCESS_START"
          nohup python -m uvicorn backend.app:app \
            --host 0.0.0.0 --port 8000 > server.log 2>&1 &

          echo "Waiting for server..."
          for i in {1..30}; do
            if curl -fsS "$BASE/health" >/dev/null 2>&1; then
              echo "Server is up."
              break
            fi
            echo "Not ready ($i/30)..."
            sleep 1
          done

          if ! curl -fsS "$BASE/health" >/dev/null 2>&1; then
            echo "ðŸš¨ Server failed to start"
            cat server.log
            exit 1
          fi

      # --------------------------
      # PYTEST (auto coverage)
      # --------------------------
      - name: Run pytest
        run: pytest tests_main.py --maxfail=0

      # --------------------------
      # POWERSHELL INTEGRATION TESTS
      # --------------------------
      - name: Pre-checks for integration tests (PowerShell)
        shell: pwsh
        env:
          BASE: "http://localhost:8000"
        run: |
          Invoke-RestMethod -Uri "$env:BASE/health" -Method Get
          Invoke-RestMethod -Uri "$env:BASE/reset" -Method Delete

      - name: Run PowerShell integration tests (auto coverage)
        shell: bash
        run: |
          echo "Running PS tests with auto coverage..."

          cat > run_ps_integration.py << 'EOF'
          import subprocess
          subprocess.check_call(["pwsh", "./integration_tests.ps1"])
          EOF

          python run_ps_integration.py

      # --------------------------
      # COMBINE & ENFORCE COVERAGE
      # --------------------------
      - name: Combine + Report Coverage (Fail <60)
        run: |
          echo "Combining coverage..."
          ls -a .
          coverage combine
          coverage report -m --fail-under=60
