# ============================================================================
# AWS QUICK STATUS CHECK - ECE461 Part 2 - Team 4
# 
# INSTRUCTIONS:
# 1. Copy everything from the opening "(" below to the closing ")"
# 2. Paste into AWS CloudShell
# 3. Press Enter
# 
# This queries AWS and shows ACTUAL resource names/values, not hardcoded text
# ============================================================================

(
clear
echo "================================================================================"
echo "                   AWS DEPLOYMENT STATUS - ECE461 Part 2"
echo "                              Region: us-east-2"
echo "================================================================================"
echo ""
echo "ðŸ“¦ BACKEND INFRASTRUCTURE"
echo "--------------------------------------------------------------------------------"

printf "ECS Service Status:      "
SERVICE_STATUS=$(aws ecs describe-services --cluster ece461-backend-cluster --services ece461-backend-service --region us-east-2 --query 'services[0].status' --output text 2>/dev/null)
RUNNING=$(aws ecs describe-services --cluster ece461-backend-cluster --services ece461-backend-service --region us-east-2 --query 'services[0].runningCount' --output text 2>/dev/null)
DESIRED=$(aws ecs describe-services --cluster ece461-backend-cluster --services ece461-backend-service --region us-east-2 --query 'services[0].desiredCount' --output text 2>/dev/null)
if [ -n "$SERVICE_STATUS" ] && [ "$SERVICE_STATUS" != "None" ]; then
  echo "${SERVICE_STATUS} (${RUNNING:-0}/${DESIRED:-0} tasks)"
else
  echo "âŒ NOT FOUND"
fi

printf "Task Definition:         "
TASK_REV=$(aws ecs describe-task-definition --task-definition ece461-backend-task --region us-east-2 --query 'taskDefinition.revision' --output text 2>/dev/null)
if [ -n "$TASK_REV" ] && [ "$TASK_REV" != "None" ]; then
  echo "ece461-backend-task:${TASK_REV}"
else
  echo "âŒ NOT FOUND"
fi

echo ""
echo ""
echo "ðŸŒ FRONTEND INFRASTRUCTURE"
echo "--------------------------------------------------------------------------------"

printf "S3 Bucket:               "
if aws s3api head-bucket --bucket ece461-frontend --region us-east-2 2>/dev/null >/dev/null; then
  echo "ece461-frontend"
else
  echo "âŒ NOT FOUND"
fi

if aws s3api head-bucket --bucket ece461-frontend --region us-east-2 2>/dev/null >/dev/null; then
  printf "  Website Index:         "
  aws s3api get-bucket-website --bucket ece461-frontend --region us-east-2 --query 'IndexDocument.Suffix' --output text 2>/dev/null || echo "Not configured"
  echo ""
  
  printf "  Files in Bucket:       "
  FILE_COUNT=$(aws s3 ls s3://ece461-frontend/ --region us-east-2 2>/dev/null | wc -l)
  echo "${FILE_COUNT:-0}"
  echo ""
  
  echo "  Website URL:           http://ece461-frontend.s3-website.us-east-2.amazonaws.com"
fi

echo ""
echo ""
echo "âš–ï¸ LOAD BALANCING & API GATEWAY"
echo "--------------------------------------------------------------------------------"

ALB_DNS=$(aws elbv2 describe-load-balancers --names ece461-alb --region us-east-2 --query 'LoadBalancers[0].DNSName' --output text 2>/dev/null)
ALB_STATUS=$(aws elbv2 describe-load-balancers --names ece461-alb --region us-east-2 --query 'LoadBalancers[0].State.Code' --output text 2>/dev/null)

printf "Load Balancer:           "
if [ -n "$ALB_DNS" ] && [ "$ALB_DNS" != "None" ]; then
  echo "${ALB_STATUS:-active}"
  echo "  DNS:                   ${ALB_DNS}"
else
  echo "âŒ NOT FOUND"
fi

TG_ARN=$(aws elbv2 describe-target-groups --names ece461-api-tg --region us-east-2 --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null)
if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
  HEALTHY=$(aws elbv2 describe-target-health --target-group-arn "$TG_ARN" --region us-east-2 --query 'TargetHealthDescriptions[?TargetHealth.State==`healthy`] | length(@)' --output text 2>/dev/null)
  TOTAL=$(aws elbv2 describe-target-health --target-group-arn "$TG_ARN" --region us-east-2 --query 'length(TargetHealthDescriptions)' --output text 2>/dev/null)
  printf "Target Health:           "
  echo "${HEALTHY:-0}/${TOTAL:-0} healthy"
fi

echo ""
API_ID=$(aws apigateway get-rest-apis --region us-east-2 --query 'items[?name==`ece461-api-gateway`].id' --output text 2>/dev/null)
printf "API Gateway:             "
if [ -n "$API_ID" ] && [ "$API_ID" != "None" ]; then
  echo "âœ… Active (ID: ${API_ID})"
  echo "  URL:                   https://${API_ID}.execute-api.us-east-2.amazonaws.com/prod"
else
  echo "âŒ NOT FOUND"
fi

echo ""
echo ""
echo "ðŸ” SECURITY & IAM"
echo "--------------------------------------------------------------------------------"

printf "IAM Roles:               "
GITHUB_ROLE=$(aws iam get-role --role-name github-actions-deploy-role --query 'Role.RoleName' --output text 2>/dev/null)
ECS_ROLE=$(aws iam get-role --role-name ecsTaskExecutionRole --query 'Role.RoleName' --output text 2>/dev/null)
if [ -n "$GITHUB_ROLE" ] && [ -n "$ECS_ROLE" ]; then
  echo "âœ… Configured"
elif [ -n "$GITHUB_ROLE" ] || [ -n "$ECS_ROLE" ]; then
  echo "âš ï¸  Partially configured"
else
  echo "âŒ NOT FOUND"
fi

printf "Security Groups:         "
# Get ECS security group from service network config
ECS_SG=$(aws ecs describe-services --cluster ece461-backend-cluster --services ece461-backend-service --region us-east-2 --query 'services[0].networkConfiguration.awsvpcConfiguration.securityGroups[0]' --output text 2>/dev/null)
# Get ALB security groups
ALB_SG=$(aws elbv2 describe-load-balancers --names ece461-alb --region us-east-2 --query 'LoadBalancers[0].SecurityGroups[0]' --output text 2>/dev/null)
if [ -n "$ECS_SG" ] && [ "$ECS_SG" != "None" ] && [ -n "$ALB_SG" ] && [ "$ALB_SG" != "None" ]; then
  echo "âœ… Configured (ECS: ${ECS_SG}, ALB: ${ALB_SG})"
elif [ -n "$ECS_SG" ] && [ "$ECS_SG" != "None" ]; then
  echo "âš ï¸  Partially configured (ECS: ${ECS_SG})"
else
  echo "âš ï¸  Check configuration"
fi

echo ""
echo ""
echo "ðŸŒ NETWORKING"
echo "--------------------------------------------------------------------------------"

# Get VPC and subnets from ECS service network config
ECS_VPC=$(aws ecs describe-services --cluster ece461-backend-cluster --services ece461-backend-service --region us-east-2 --query 'services[0].networkConfiguration.awsvpcConfiguration.subnets' --output text 2>/dev/null)
if [ -n "$ECS_VPC" ] && [ "$ECS_VPC" != "None" ]; then
  # Get first subnet to find VPC
  FIRST_SUBNET=$(echo "$ECS_VPC" | awk '{print $1}')
  VPC_ID=$(aws ec2 describe-subnets --subnet-ids "$FIRST_SUBNET" --region us-east-2 --query 'Subnets[0].VpcId' --output text 2>/dev/null)
  
  printf "VPC:                     "
  if [ -n "$VPC_ID" ] && [ "$VPC_ID" != "None" ]; then
    CIDR=$(aws ec2 describe-vpcs --vpc-ids "$VPC_ID" --region us-east-2 --query 'Vpcs[0].CidrBlock' --output text 2>/dev/null)
    echo "${VPC_ID} (${CIDR})"
  else
    echo "âŒ NOT FOUND"
  fi
  
  printf "Subnets:                 "
  SUBNET_LIST=$(echo "$ECS_VPC" | tr '\t' ',' | sed 's/,$//')
  if [ -n "$SUBNET_LIST" ]; then
    echo "$SUBNET_LIST"
  else
    echo "âš ï¸  Check configuration"
  fi
else
  printf "VPC:                     "
  echo "âŒ NOT FOUND"
  printf "Subnets:                 "
  echo "âŒ NOT FOUND"
fi

echo ""
echo ""
echo "ðŸ“Š DEPLOYMENT INFO"
echo "--------------------------------------------------------------------------------"

IMAGE_COUNT=$(aws ecr list-images --repository-name ece461-backend --region us-east-2 --query 'length(imageIds)' --output text 2>/dev/null)
printf "ECR Images:              "
if [ -n "$IMAGE_COUNT" ] && [ "$IMAGE_COUNT" -gt 0 ]; then
  echo "${IMAGE_COUNT} total"
else
  echo "0"
fi

printf "Last Deployment:         "
LAST_DEPLOY=$(aws ecs describe-services --cluster ece461-backend-cluster --services ece461-backend-service --region us-east-2 --query 'services[0].deployments[0].updatedAt' --output text 2>/dev/null)
if [ -n "$LAST_DEPLOY" ] && [ "$LAST_DEPLOY" != "None" ]; then
  echo "$LAST_DEPLOY"
else
  echo "N/A"
fi

echo ""
echo ""
echo "ðŸ”— ACCESS YOUR APPLICATION"
echo "--------------------------------------------------------------------------------"

TASK_ARN=$(aws ecs list-tasks --cluster ece461-backend-cluster --service-name ece461-backend-service --region us-east-2 --query 'taskArns[0]' --output text 2>/dev/null)

API_ID=$(aws apigateway get-rest-apis --region us-east-2 --query 'items[?name==`ece461-api-gateway`].id' --output text 2>/dev/null)
ALB_DNS=$(aws elbv2 describe-load-balancers --names ece461-alb --region us-east-2 --query 'LoadBalancers[0].DNSName' --output text 2>/dev/null)

if [ -n "$API_ID" ] && [ "$API_ID" != "None" ]; then
  echo "Backend API (Primary):"
  echo "  â€¢ API Gateway:         https://${API_ID}.execute-api.us-east-2.amazonaws.com/prod"
  echo "  â€¢ Health Check:        https://${API_ID}.execute-api.us-east-2.amazonaws.com/prod/health"
  if [ -n "$ALB_DNS" ] && [ "$ALB_DNS" != "None" ]; then
    echo "  â€¢ ALB (Direct):        http://${ALB_DNS}"
  fi
else
  echo "Backend API:             âŒ API Gateway not found"
fi

echo ""
echo "Frontend:"
echo "  â€¢ Website:             http://ece461-frontend.s3-website.us-east-2.amazonaws.com"

echo ""
echo "================================================================================"
echo "                           âœ… Status Check Complete!"
echo "================================================================================"
echo ""
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text 2>/dev/null)
echo "Account: ${ACCOUNT_ID:-Unknown} | Region: us-east-2"
echo ""
)
